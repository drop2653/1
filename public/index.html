<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>1:1 ìŠˆíŒ…ê²Œìž„</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; background: #222; }
    #message {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      color: white;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="message"></div>
  <audio id="shotSound" src="shot.mp3"></audio>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const shotSound = document.getElementById('shotSound');
    const message = document.getElementById('message');

    let players = {};
    let bullets = [];

    const localPlayer = {
      id: null,
      x: 200,
      y: 200,
      size: 20,
      speed: 3,
      hp: 10,
      pressing: { w: false, a: false, s: false, d: false }
    };

    let gameOver = false;

    // í‚¤ ìž…ë ¥
    window.addEventListener('keydown', e => {
      if (e.key === 'w') localPlayer.pressing.w = true;
      if (e.key === 'a') localPlayer.pressing.a = true;
      if (e.key === 's') localPlayer.pressing.s = true;
      if (e.key === 'd') localPlayer.pressing.d = true;
    });

    window.addEventListener('keyup', e => {
      if (e.key === 'w') localPlayer.pressing.w = false;
      if (e.key === 'a') localPlayer.pressing.a = false;
      if (e.key === 's') localPlayer.pressing.s = false;
      if (e.key === 'd') localPlayer.pressing.d = false;
    });

    // ë°œì‚¬
    window.addEventListener('click', e => {
      if (gameOver) return;
      const angle = Math.atan2(e.clientY - localPlayer.y, e.clientX - localPlayer.x);
      const bullet = {
        x: localPlayer.x,
        y: localPlayer.y,
        angle: angle,
        from: localPlayer.id
      };
      socket.emit('shoot', bullet);
      shotSound.currentTime = 0;
      shotSound.play();
    });

    socket.on('init', id => {
      localPlayer.id = id;
    });

    socket.on('updatePlayers', serverPlayers => {
      players = serverPlayers;
      if (players[localPlayer.id]) {
        localPlayer.hp = players[localPlayer.id].hp;
        if (localPlayer.hp <= 0 && !gameOver) {
          message.textContent = 'ðŸ’¥ YOU LOSE!';
          message.style.display = 'block';
          gameOver = true;
        }
        // WIN ì¡°ê±´
        const enemies = Object.values(players).filter(p => p.id !== localPlayer.id && p.hp <= 0);
        if (enemies.length > 0 && !gameOver) {
          message.textContent = 'ðŸ† YOU WIN!';
          message.style.display = 'block';
          gameOver = true;
        }
      }
    });

    socket.on('updateBullets', serverBullets => {
      bullets = serverBullets;
    });

    function update() {
      if (gameOver) return;
      if (localPlayer.pressing.w) localPlayer.y -= localPlayer.speed;
      if (localPlayer.pressing.s) localPlayer.y += localPlayer.speed;
      if (localPlayer.pressing.a) localPlayer.x -= localPlayer.speed;
      if (localPlayer.pressing.d) localPlayer.x += localPlayer.speed;
      socket.emit('move', { x: localPlayer.x, y: localPlayer.y });
    }

    function drawHPBar(player) {
      const hpWidth = 40;
      const hpX = player.x - hpWidth / 2;
      const hpY = player.y - 40;
      ctx.fillStyle = 'gray';
      ctx.fillRect(hpX, hpY, hpWidth, 6);
      ctx.fillStyle = 'lime';
      const ratio = Math.max(0, player.hp / 10);
      ctx.fillRect(hpX, hpY, hpWidth * ratio, 6);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let id in players) {
        const p = players[id];
        ctx.beginPath();
        ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
        ctx.fillStyle = id === localPlayer.id ? 'white' : 'red';
        ctx.fill();
        drawHPBar(p);
      }

      ctx.fillStyle = 'yellow';
      bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>
